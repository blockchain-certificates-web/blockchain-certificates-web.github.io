import{d as e,e as t}from"./index-VOqA2-xz-CKqwdkuf.js";import{d as r}from"./base64url-Cy03LJLt-vkTPfQOh.js";import{a as n}from"./elliptic-6eMlPaPZ-CGOSt2J1.js";
/*!
 * Copyright (c) 2023 Digital Bazaar, Inc. All rights reserved.
 */
const i="ECDSA",c=!0,u="https://w3id.org/security/suites/ecdsa-2019/v1",y="https://w3id.org/security/multikey/v1",o="z",s=new Uint8Array([231,1]),a=new Uint8Array([128,36]),l=new Uint8Array([129,36]),p=new Uint8Array([130,36]),w=new Uint8Array([134,33]),b=new Uint8Array([134,38]),f=new Uint8Array([135,38]),k=new Uint8Array([136,38]),K="P-256",d="P-384",m="P-521",h="K-256",g="SHA-256",v="SHA-384",A="SHA-512",M=globalThis.crypto,E=globalThis.CryptoKey??M.CryptoKey;function U({curve:e}){if(e===K||e===h)return g;if(e===d)return v;if(e===m)return A;throw new TypeError(`Unsupported curve "${e}".`)}
/*!
 * Copyright (c) 2022-2023 Digital Bazaar, Inc. All rights reserved.
 */function x({publicMultikey:e}){if(e[0]===a[0]&&e[1]===a[1])return K;if(e[0]===l[0]&&e[1]===l[1])return d;if(e[0]===p[0]&&e[1]===p[1])return m;if(e[0]===s[0]&&e[1]===s[1])return h;throw new TypeError("Unsupported public multikey header.")}function C({secretMultikey:e}){if(e[0]===b[0]&&e[1]===b[1])return K;if(e[0]===f[0]&&e[1]===f[1])return d;if(e[0]===k[0]&&e[1]===k[1])return m;if(e[0]===w[0]&&e[1]===w[1])return h;throw new TypeError("Unsupported secret multikey header.")}function j({curve:e}){if(e===K||e===h)return 32;if(e===d)return 48;if(e===m)return 66;throw new TypeError(`Unsupported curve "${e}".`)}
/*!
 * Copyright (c) 2022-2023 Digital Bazaar, Inc. All rights reserved.
 */
const P=new Map([[K,{secret:new Uint8Array([48,103,2,1,0,48,19,6,7,42,134,72,206,61,2,1,6,8,42,134,72,206,61,3,1,7,4,77,48,75,2,1,1,4,32]),public:new Uint8Array([161,36,3,34,0])}],[d,{secret:new Uint8Array([48,129,132,2,1,0,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,34,4,109,48,107,2,1,1,4,48]),public:new Uint8Array([161,52,3,50,0])}],[m,{secret:new Uint8Array([48,129,170,2,1,0,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,35,4,129,146,48,129,143,2,1,1,4,66]),public:new Uint8Array([161,70,3,68,0])}],[h,{secret:new Uint8Array([48,129,132,2,1,0,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,10,4,109,48,107,2,1,1,4,32]),public:new Uint8Array([161,68,3,66,0])}]]),T=new Map([[K,new Uint8Array([48,57,48,19,6,7,42,134,72,206,61,2,1,6,8,42,134,72,206,61,3,1,7,3,34,0])],[d,new Uint8Array([48,70,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,34,3,50,0])],[m,new Uint8Array([48,88,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,35,3,68,0])],[h,new Uint8Array([48,86,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,10,3,66,0])]]);function R(e){const t=new n.ec("secp256k1");return Uint8Array.from(t.keyFromPublic(e).getPublic(!1,"array"))}async function S({id:t,controller:r,secretKeyMultibase:n,publicKeyMultibase:u,keyAgreement:y=!1}){if(!u)throw new TypeError('The "publicKeyMultibase" property is required.');const s={id:t,controller:r};if(!u||"string"!=typeof u||u[0]!==o)throw new TypeError('"publicKeyMultibase" must be a multibase, base58-encoded string.');const a=e(u.slice(1)),l={name:y?"ECDH":i,namedCurve:x({publicMultikey:a})},p=function({publicMultikey:e}){const t=x({publicMultikey:e});let r=e.subarray(2);t===h&&(r=R(r));return function({curve:e,publicKey:t}){const r=T.get(e),n=new Uint8Array(r.length+t.length);let i=0;return n.set(r,i),i+=r.length,n.set(t,i),n}
/*!
 * Copyright (c) 2023 Digital Bazaar, Inc. All rights reserved.
 */({curve:t,publicKey:r})}({publicMultikey:a}),w=y?[]:["verify"];if(l.namedCurve===h){const{Crypto:e}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),t=new e;s.publicKey=await t.subtle.importKey("spki",p,l,c,w)}else s.publicKey=await M.subtle.importKey("spki",p,l,c,w);if(n){if("string"!=typeof n||n[0]!==o)throw new TypeError('"secretKeyMultibase" must be a multibase, base58-encoded string.');const t=e(n.slice(1));!function({secretMultikey:e,publicMultikey:t}){const r=x({publicMultikey:t}),n=C({secretMultikey:e});if(r!==n)throw new Error(`Public key curve ('${r}') does not match secret key curve ('${n}').`)}({secretMultikey:t,publicMultikey:a});const r=function({secretMultikey:e,publicMultikey:t}){const r=C({secretMultikey:e}),n=e.subarray(2),i=t.subarray(2);return function({curve:e,secretKey:t,publicKey:r}){const n=P.get(e);if(!n)throw new Error(`Unsupported curve "${e}".`);e===h&&(r=R(r));const i=new Uint8Array(n.secret.length+t.length+n.public.length+r.length);let c=0;return i.set(n.secret,c),c+=n.secret.length,i.set(t,c),c+=t.length,i.set(n.public,c),c+=n.public.length,i.set(r,c),i}({curve:r,secretKey:n,publicKey:i})}({secretMultikey:t,publicMultikey:a}),i=y?["deriveBits"]:["sign"];if(l.namedCurve===h){const{Crypto:e}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),t=new e;s.secretKey=await t.subtle.importKey("pkcs8",r,l,c,i)}else s.secretKey=await M.subtle.importKey("pkcs8",r,l,c,i)}return s}function $({jwk:e}={}){if("EC"!==e?.kty)throw new TypeError('"jwk.kty" must be "EC".');const{crv:n}=e,i=j({curve:n}),c=r(e.x),u=r(e.y),y=new Uint8Array(2+(i+1));!function({curve:e,buffer:t}){if(e===K)t[0]=a[0],t[1]=a[1];else if(e===d)t[0]=l[0],t[1]=l[1];else if(e===m)t[0]=p[0],t[1]=p[1];else{if(e!==h)throw new TypeError(`Unsupported curve "${e}".`);t[0]=s[0],t[1]=s[1]}}({curve:n,buffer:y});const w=u[u.length-1]%2==0;y[2]=w?2:3,y.set(c,y.length-c.length);return o+t(y)}function D({jwk:e}={}){if("EC"!==e?.kty)throw new TypeError('"jwk.kty" must be "EC".');const{crv:n}=e,i=j({curve:n}),c=r(e.d),u=new Uint8Array(2+i);!function({curve:e,buffer:t}){if(e===K)t[0]=b[0],t[1]=b[1];else if(e===d)t[0]=f[0],t[1]=f[1];else if(e===m)t[0]=k[0],t[1]=k[1];else{if(e!==h)throw new TypeError(`Unsupported curve "${e}".`);t[0]=w[0],t[1]=w[1]}}({curve:e.crv,buffer:u}),u.set(c,u.length-c.length);return o+t(u)}const Q=new Set(["EcdsaSecp256r1VerificationKey2019","EcdsaSecp384r1VerificationKey2019","EcdsaSecp521r1VerificationKey2019","EcdsaSecp256k1VerificationKey2019"]);async function q({keyPair:e}){if(!Q.has(e.type))throw new TypeError(`Unsupported key type "${e.type}".`);if(e["@context"]||(e["@context"]=u),!function({document:e,contextUrl:t}){const r=e["@context"];return r===t||Array.isArray(r)&&r.includes(t)}
/*!
 * Copyright (c) 2022-2023 Digital Bazaar, Inc. All rights reserved.
 */({document:e,contextUrl:u}))throw new TypeError(`Context not supported "${e["@context"]}".`);return{"@context":y,id:e.id,type:"Multikey",controller:e.controller,publicKeyMultibase:e.publicKeyMultibase,secretKeyMultibase:e.secretKeyMultibase}}async function H(e,t={}){"boolean"==typeof t&&(t={keyAgreement:t});const{keyAgreement:r}=t;let n={...e};if("Multikey"!==n.type){if(n.publicKeyJwk)return async function({jwk:e,secretKey:t=!1}={}){const r={"@context":y,type:"Multikey",publicKeyMultibase:$({jwk:e})};t&&e.d&&(r.secretKeyMultibase=D({jwk:e}));const n=!e.key_ops||e.key_ops.includes("deriveBits");return H(r,n)}({jwk:n.publicKeyJwk,secretKey:!1});if(n.type)return n=await q({keyPair:n}),B({keyPair:n,keyAgreement:r})}return n.type||(n.type="Multikey"),n["@context"]||(n["@context"]=y),n.controller&&!n.id&&(n.id=`${e.controller}#${e.publicKeyMultibase}`),function(e){if(!e||"object"!=typeof e)throw new TypeError('"key" must be an object.');if("Multikey"!==e.type)throw new TypeError('"key" must be a Multikey with type "Multikey".');if(!(e["@context"]===y||Array.isArray(e["@context"])&&e["@context"].includes(y)))throw new TypeError(`"key" must be a Multikey with context "${y}".`)}(n),B({keyPair:n,keyAgreement:r})}async function V({keyPair:e,secretKey:t=!1}={}){e?.publicKey instanceof E||(e=await S(e));const r=t&&!!e.secretKey?e.secretKey:e.publicKey;let n;if(e.publicKey.algorithm.namedCurve===h){const{Crypto:e}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),t=new e;n=await t.subtle.exportKey("jwk",r)}else n=await M.subtle.exportKey("jwk",r);return n}async function B({keyPair:e,keyAgreement:t=!1}){e?.publicKey instanceof E||e.publicKey?.algorithm.namedCurve===h||(e=await S(e));const n=async({publicKey:t=!0,secretKey:n=!1,includeContext:i=!0,raw:c=!1}={})=>{if(c){const i=await V({keyPair:e,secretKey:n}),c={};return t&&(c.publicKey=function({jwk:e}={}){if("EC"!==e?.kty)throw new TypeError('"jwk.kty" must be "EC".');const{crv:t}=e,n=j({curve:t}),i=r(e.x),c=r(e.y),u=new Uint8Array(n+1),y=c[c.length-1]%2==0;return u[0]=y?2:3,u.set(i,u.length-i.length),u}({jwk:i})),n&&(c.secretKey=function({jwk:e}={}){if("EC"!==e?.kty)throw new TypeError('"jwk.kty" must be "EC".');const{crv:t}=e,n=j({curve:t}),i=r(e.d),c=new Uint8Array(n);return c.set(i,c.length-i.length),c}({jwk:i})),c}return async function({keyPair:e,secretKey:t,publicKey:r,includeContext:n}={}){if(!r&&!t)throw new TypeError('Export requires specifying either "publicKey" or "secretKey".');const i=t&&!!e.secretKey,c=i?e.secretKey:e.publicKey;let u;if(c.algorithm.namedCurve===h){const{Crypto:e}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),t=new e;u=await t.subtle.exportKey("jwk",c)}else u=await M.subtle.exportKey("jwk",c);const o={};return n&&(o["@context"]=y),o.id=e.id,o.type="Multikey",o.controller=e.controller,r&&(o.publicKeyMultibase=$({jwk:u})),i&&(o.secretKeyMultibase=D({jwk:u})),o}({keyPair:e,publicKey:t,secretKey:n,includeContext:i})},{publicKeyMultibase:c,secretKeyMultibase:u}=await n({publicKey:!0,secretKey:!0,includeContext:!0});return e={...e,publicKeyMultibase:c,secretKeyMultibase:u,keyAgreement:t,export:n,signer(){const{id:t,secretKey:r}=e;
/*!
 * Copyright (c) 2022-2023 Digital Bazaar, Inc. All rights reserved.
 */
return function({id:e,secretKey:t}){if(!t)throw new Error('"secretKey" is required for signing.');const{namedCurve:r}=t.algorithm,n={name:i,hash:{name:U({curve:r})}};return{algorithm:r,id:e,async sign({data:e}={}){if(r===h){const{Crypto:r}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),i=new r;return new Uint8Array(await i.subtle.sign(n,t,e))}return new Uint8Array(await M.subtle.sign(n,t,e))}}}({id:t,secretKey:r})},verifier(){const{id:t,publicKey:r}=e;return function({id:e,publicKey:t}){if(!t)throw new Error('"publicKey" is required for verifying.');const{namedCurve:r}=t.algorithm,n={name:i,hash:{name:U({curve:r})}};return{algorithm:r,id:e,async verify({data:e,signature:i}={}){if(r===h){const{Crypto:r}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js");return(new r).subtle.verify(n,t,i,e)}return M.subtle.verify(n,t,i,e)}}}({id:t,publicKey:r})},async deriveSecret({publicKey:t,remotePublicKey:r}={}){if(r&&t)throw new Error('Only one of "remotePublicKey" and "publicKey" must be given.');if(!e.keyAgreement){const e=Error('"keyAgreement" is not supported by this keypair.');throw e.name="NotSupportedError",e}return async function({localKeyPair:e,remoteKeyPair:t}){if(!e.secretKey){const e=Error('"secretKey" required to derive secret.');throw e.name="NotSupportedError",e}e=await S({...e,keyAgreement:!0}),t=await S({...t,keyAgreement:!0});const{namedCurve:r}=e.secretKey.algorithm,n=j({curve:r});if(r===h){const{Crypto:i}=await import("./webcrypto.es-DQnPRx8R-BJSH271h.js"),c=new i,u=await c.subtle.deriveBits({name:"ECDH",namedCurve:r,public:t.publicKey},e.secretKey,8*n);return new Uint8Array(u,0,n)}const i=await M.subtle.deriveBits({name:"ECDH",namedCurve:r,public:t.publicKey},e.secretKey,8*n);return new Uint8Array(i,0,n)}({localKeyPair:this,remoteKeyPair:r||t})}}}export{H as f,V as t};
